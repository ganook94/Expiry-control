<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carrefour Expiry Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        /* ... (existing CSS remains unchanged) ... */
        
        /* New styles for date input */
        .date-input-container {
            position: relative;
        }
        
        .date-input-container input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
        }
        
        .date-input-container input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        
        .date-input-container i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #00387b;
        }
    </style>
</head>
<body>
    <!-- ... (existing HTML remains unchanged until expiry date input) ... -->
    
    <div class="form-group">
        <label for="expiry-date"><i class="fas fa-calendar-day"></i> Expiry Date</label>
        <div class="date-input-container">
            <input type="date" id="expiry-date" required>
            <i class="fas fa-calendar-alt"></i>
        </div>
    </div>
    
    <!-- ... (remaining HTML remains unchanged) ... -->

    <script>
        // ... (existing code until storage initialization) ...
        
        // Date migration to ISO format (YYYY-MM-DD)
        storage.expiryRecords = storage.expiryRecords.map(record => {
            if (record.expiryDate && record.expiryDate.includes('/')) {
                const [year, month, day] = record.expiryDate.split('/');
                record.expiryDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return record;
        });
        
        // ... (existing storage methods remain unchanged) ...
        
        // Universal date parser
        function parseDate(dateString) {
            if (!dateString) return null;
            return new Date(dateString);
        }
        
        // Format date to YYYY-MM-DD (ISO format)
        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
        
        // Format date for display (YYYY/MM/DD)
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            return dateString.replace(/-/g, '/');
        }
        
        // ... (existing excelManager remains unchanged) ...
        
        // Scanning Manager - Enhanced Workflow
        const scannerManager = {
            isScanning: false,
            currentRecordIndex: null,
            scanSuccessElement: null,
            tipsVisible: true,
            continuousScanning: false,
            lastScannedCode: null,
            lastScanTime: 0,
            scanTimeout: null,

            init() {
                // ... (existing initialization) ...
                
                // Add event listener for date input
                document.getElementById('expiry-date').addEventListener('change', this.checkForDuplicate.bind(this));
            },
            
            // ... (existing methods remain unchanged until startCamera) ...
            
            async startCamera() {
                if (this.isScanning) return;
                
                // Set continuous scanning flag
                this.continuousScanning = true;
                
                // Check for secure context
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    storage.showNotification("Camera requires HTTPS. Please load the page via HTTPS.", 'error');
                    return;
                }
                
                try {
                    // Initialize Quagga with better configuration
                    await this.initQuagga();
                    
                    // Start Quagga
                    Quagga.start();
                    
                    this.isScanning = true;
                    
                    // Update UI
                    document.getElementById('stop-camera').disabled = false;
                    document.getElementById('camera-status').innerHTML = 
                        '<i class="fas fa-check-circle"></i> Camera active. Scan a barcode...';
                    document.getElementById('camera-status').style.background = '#e3f9ee';
                    document.getElementById('camera-status').style.color = '#237f52';
                    
                    storage.showNotification('Camera started. Scanning for barcodes...', 'success');
                    
                } catch (error) {
                    console.error("Error starting camera:", error);
                    // ... (error handling remains unchanged) ...
                }
            },
            
            async initQuagga() {
                return new Promise((resolve, reject) => {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#camera-preview'),
                            constraints: {
                                facingMode: "environment",
                                width: { min: 1280, ideal: 1920 },
                                height: { min: 720, ideal: 1080 }
                            }
                        },
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "code_39_reader",
                                "code_39_vin_reader",
                                "codabar_reader",
                                "upc_reader",
                                "upc_e_reader"
                            ],
                            debug: {
                                drawBoundingBox: false,
                                showFrequency: false,
                                drawScanline: false,
                                showPattern: false
                            },
                            multiple: false
                        },
                        locate: true,
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        frequency: 5, // Slower scanning for better accuracy
                        locator: {
                            halfSample: true,
                            patchSize: "large",
                            debug: {
                                showCanvas: false,
                                showPatches: false,
                                showFoundPatches: false,
                                showSkeleton: false
                            }
                        }
                    }, (err) => {
                        if (err) {
                            console.error("Quagga init error:", err);
                            reject(err);
                            return;
                        }
                        
                        // Set up detection callback
                        Quagga.onDetected(this.onBarcodeDetected.bind(this));
                        
                        resolve();
                    });
                });
            },
            
            onBarcodeDetected(result) {
                if (!this.isScanning) return;
                
                const code = result.codeResult.code;
                const now = Date.now();
                
                // Debounce: Ignore same code within 2 seconds
                if (code === this.lastScannedCode && (now - this.lastScanTime) < 2000) {
                    return;
                }
                
                console.log("Barcode detected:", code);
                this.lastScannedCode = code;
                this.lastScanTime = now;
                
                // Clear any previous timeout
                if (this.scanTimeout) {
                    clearTimeout(this.scanTimeout);
                }
                
                // Give visual feedback
                this.showScanFeedback(true);
                
                // Process the barcode after a short delay
                this.scanTimeout = setTimeout(() => {
                    this.processBarcode(code);
                }, 500);
            },
            
            // ... (other methods remain unchanged) ...
            
            showExpiryForm(product) {
                storage.currentProduct = product;
                
                // Populate product details
                document.getElementById('form-barcode').textContent = product.barcode;
                document.getElementById('form-itemno').textContent = product.itemNo;
                document.getElementById('form-description').textContent = product.description;
                
                // Reset form fields
                document.getElementById('batch-number').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('expiry-date').value = '';
                this.currentRecordIndex = null;
                
                // Hide duplicate warning
                document.getElementById('duplicate-warning').style.display = 'none';
                
                // Show the form
                document.getElementById('expiry-form').style.display = 'block';
                
                // Scroll to the form
                document.getElementById('expiry-form').scrollIntoView({ behavior: 'smooth' });
                
                // Set min date to today for expiry date
                const today = new Date();
                const minDate = formatDate(today);
                document.getElementById('expiry-date').min = minDate;
            },
            
            editRecord(index) {
                const record = storage.expiryRecords[index];
                const product = storage.products.find(p => p.barcode === record.barcode);
                
                if (!product) {
                    storage.showNotification("Product not found in database", 'error');
                    return;
                }
                
                storage.currentProduct = product;
                this.currentRecordIndex = index;
                
                // Populate product details
                document.getElementById('form-barcode').textContent = product.barcode;
                document.getElementById('form-itemno').textContent = product.itemNo;
                document.getElementById('form-description').textContent = product.description;
                
                // Populate form fields
                document.getElementById('batch-number').value = record.batch;
                document.getElementById('quantity').value = record.quantity;
                document.getElementById('expiry-date').value = record.expiryDate;
                
                // Show the form
                document.getElementById('expiry-form').style.display = 'block';
                
                // Scroll to the form
                document.getElementById('expiry-form').scrollIntoView({ behavior: 'smooth' });
            },
            
            // ... (other methods remain unchanged) ...
            
            saveExpiryRecord() {
                // Validate inputs
                if (!this.validateBatchNumber()) {
                    storage.showNotification("Batch number must be 4-20 alphanumeric characters (may include - and _)", 'error');
                    return;
                }
                
                const quantity = parseInt(document.getElementById('quantity').value);
                if (isNaN(quantity) || quantity < 1) {
                    storage.showNotification("Please enter a valid quantity (minimum 1)", 'error');
                    return;
                }
                
                const expiryDate = document.getElementById('expiry-date').value;
                if (!expiryDate) {
                    storage.showNotification("Please select an expiry date", 'error');
                    return;
                }
                
                // Create record
                const record = {
                    barcode: storage.currentProduct.barcode,
                    itemNo: storage.currentProduct.itemNo,
                    description: storage.currentProduct.description,
                    batch: document.getElementById('batch-number').value,
                    quantity: quantity,
                    expiryDate: expiryDate,
                    scannedDate: formatDate(new Date())
                };
                
                // Save or update record
                if (this.currentRecordIndex === null) {
                    storage.addRecord(record);
                } else {
                    storage.updateRecord(this.currentRecordIndex, record);
                }
                
                // Hide form
                this.hideForm();
            }
        };
        
        // ... (existing exportManager remains unchanged) ...
        
        // Update renderExpiryTable to display dates in YYYY/MM/DD format
        storage.renderExpiryTable = function() {
            const container = document.getElementById('expiry-body');
            
            if (this.expiryRecords.length === 0) {
                container.innerHTML = `<tr><td colspan="7" class="empty-state">
                    <i class="fas fa-file-medical"></i>
                    <p>No expiry records yet. Scan products to add records.</p>
                </td></tr>`;
                return;
            }
            
            let html = '';
            this.expiryRecords.forEach((record, index) => {
                // ... (existing status calculation) ...
                
                // Format date for display
                const displayDate = formatDisplayDate(record.expiryDate);
                
                html += `
                    <tr>
                        <td>${record.barcode}</td>
                        <td>${record.itemNo}</td>
                        <td>${record.batch}</td>
                        <td>${record.quantity}</td>
                        <td>${displayDate}</td>
                        <td><span class="expiry-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-index="${index}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" data-index="${index}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            // ... (existing event listeners) ...
        };
        
        // ... (remaining code remains unchanged) ...
    </script>
</body>
</html>
